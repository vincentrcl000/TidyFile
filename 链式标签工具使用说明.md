# 链式标签工具使用说明

## 工具概述

`batch_add_chain_tags.py` 是一个功能强大的链式标签处理工具，支持批量添加、格式化、清理和智能推荐链式标签。

## 主要功能

### 1. 基础功能
- **批量添加链式标签**：从文件路径中提取并添加链式标签
- **试运行模式**：预览处理结果而不修改原文件
- **强制更新**：重新生成所有链式标签，跳过去重检测
- **文件指定**：处理指定的JSON文件

### 2. 数据查看和分析
- **扫描标签情况**：统计现有链式标签的分布情况
- **显示样本数据**：查看指定数量的记录详情

### 3. 标签清理功能
- **删除分级标签**：移除所有"X级标签"字段
- **格式化标签**：清理特殊字符、多余空格，保留年份数字
- **完整清理**：删除分级标签 + 格式化链式标签

### 4. 记录清理功能
- **删除失败记录**：移除"最匹配的目标目录"为"分类失败"的记录
- **删除空摘要记录**：移除"文件摘要"为"文件内容为空或过短"的记录

### 5. 智能标签功能（增强版）
- **自动分析**：自动调用 `analyze_chain_tags.py` 分析和生成 `chain_tags_list.txt`
- **逐层推荐**：使用AI逐层推荐标签（一级→二级→三级）
- **智能处理**：支持处理链式标签为空的记录和没有标签字段的记录（如在线文章）
- **优雅失败**：当任何级别匹配失败时，优雅地停止在上一级，避免强制推荐不相关标签
- **详细监控**：提供详细的调试信息和推荐过程监控

## 使用方法

### 基础功能
```bash
# 正常处理（跳过已有链式标签的记录）
python batch_add_chain_tags.py

# 试运行，查看处理结果但不修改文件
python batch_add_chain_tags.py --dry-run

# 强制更新所有记录的链式标签
python batch_add_chain_tags.py --force-update

# 处理指定的JSON文件
python batch_add_chain_tags.py --file my_result.json
```

### 数据查看和分析
```bash
# 仅扫描当前链式标签情况
python batch_add_chain_tags.py --scan-only

# 显示前5条记录的标签信息
python batch_add_chain_tags.py --sample 5
```

### 标签清理功能
```bash
# 删除所有分级标签（1级标签、2级标签等）
python batch_add_chain_tags.py --remove-level-tags

# 格式化链式标签，清理特殊字符和多余空格
python batch_add_chain_tags.py --format-tags

# 完整清理：删除分级标签 + 格式化链式标签
python batch_add_chain_tags.py --clean-all
```

### 记录清理功能
```bash
# 删除"最匹配的目标目录"为"分类失败"的记录
python batch_add_chain_tags.py --remove-failed

# 删除"文件摘要"为"文件内容为空或过短"的记录
python batch_add_chain_tags.py --remove-empty-summary
```

### 智能标签功能（增强版）
```bash
# 智能标签功能：使用AI推荐三级标签
python batch_add_chain_tags.py --smart-tags

# 智能标签功能试运行
python batch_add_chain_tags.py --smart-tags --dry-run
```

## 智能标签功能详解

### 工作流程
1. **自动分析**：调用 `analyze_chain_tags.py` 分析现有标签并生成 `chain_tags_list.txt`
2. **逐层推荐**：
   - 第一步：推荐一级标签
   - 第二步：基于一级标签推荐二级标签
   - 第三步：基于一级和二级标签推荐三级标签
3. **优雅处理**：当任何级别匹配失败时，停止在上一级
4. **智能识别**：支持处理本地文件和在线文章

### 优化特性
- **避免强制推荐**：不会推荐与文件内容不相关的标签
- **支持"无匹配"**：当找不到相关标签时，AI会返回"无匹配"
- **详细调试**：提供完整的推荐过程监控信息
- **自动集成**：自动调用分析工具，无需手动准备数据

## 格式化规则

### 一级目录格式化
- 保留数字（如"01"、"02"等）
- 移除【】括号，保留括号内数字
- 清理特殊字符和多余空格
- 示例：`【01】策略报告集合` → `01策略报告集合`

### 其他级别格式化
- 移除所有数字（除了年份）
- 移除各种括号（【】、()、[]）
- 保留年份数字
- 清理特殊字符和多余空格

## 注意事项

1. **自动备份**：所有修改操作都会自动备份原文件
2. **试运行建议**：建议先使用 `--dry-run` 模式预览结果
3. **智能标签**：智能标签功能会自动调用分析工具，确保数据最新
4. **错误处理**：工具具有完善的错误处理机制，出错时会保留原数据
5. **编码支持**：支持UTF-8编码，兼容中文内容

## 常见使用场景

### 场景1：首次处理数据
```bash
# 1. 先扫描了解情况
python batch_add_chain_tags.py --scan-only

# 2. 试运行查看效果
python batch_add_chain_tags.py --dry-run

# 3. 正式处理
python batch_add_chain_tags.py
```

### 场景2：清理和格式化
```bash
# 完整清理：删除分级标签 + 格式化链式标签
python batch_add_chain_tags.py --clean-all --dry-run
python batch_add_chain_tags.py --clean-all
```

### 场景3：智能推荐标签
```bash
# 智能推荐标签（试运行）
python batch_add_chain_tags.py --smart-tags --dry-run

# 智能推荐标签（正式处理）
python batch_add_chain_tags.py --smart-tags
```

### 场景4：处理在线文章
```bash
# 智能标签功能会自动处理没有标签字段的在线文章
python batch_add_chain_tags.py --smart-tags
```

## 技术支持

如果遇到问题，可以：
1. 使用 `--help` 查看详细帮助信息
2. 使用 `--dry-run` 模式预览操作结果
3. 检查备份文件（格式：原文件名.backup_YYYYMMDD_HHMMSS）
4. 查看控制台输出的详细错误信息

---

**更新时间**：2025-01-27  
**版本**：增强版  
**作者**：AI Assistant 