# 链式标签工具使用说明

## 概述

链式标签工具用于为 `ai_organize_result.json` 中的现有记录批量添加"链式标签"。链式标签将文件路径中的各级目录用 '/' 分隔符连接起来，形成完整的路径标签。

## 功能特点

1. **保留原有标签**：不会删除或修改现有的级标签（1级标签、2级标签等）
2. **新增链式标签**：自动生成"链式标签"字段
3. **智能提取**：从多个字段中智能提取级标签信息
4. **安全备份**：自动备份原文件
5. **试运行模式**：支持试运行，不修改原文件

## 使用方法

### 1. 查看样本数据

```bash
# 显示前3条记录的标签信息
python batch_add_chain_tags.py --sample 3

# 显示前5条记录的标签信息
python batch_add_chain_tags.py -s 5
```

### 2. 试运行模式

```bash
# 试运行，不修改原文件
python batch_add_chain_tags.py --dry-run

# 或使用简写
python batch_add_chain_tags.py -d
```

### 3. 实际执行

```bash
# 实际执行，会修改原文件并自动备份
python batch_add_chain_tags.py
```

### 4. 处理其他文件

```bash
# 处理指定的JSON文件
python batch_add_chain_tags.py --file my_result.json

# 或使用简写
python batch_add_chain_tags.py -f my_result.json
```

## 标签提取逻辑

工具会按以下优先级从记录中提取级标签：

1. **从"标签"字段提取**：查找所有"X级标签"字段
2. **从"最匹配的目标目录"提取**：分割路径获取各级目录
3. **从"最终目标路径"提取**：去掉盘符和一级目录，获取业务路径

## 输出格式示例

### 修改前：
```json
{
  "文件名": "示例文件.pdf",
  "最终目标路径": "E:\\资料整理\\【02】宏观经济研究\\2020年\\示例文件.pdf",
  "标签": {
    "1级标签": "【02】宏观经济研究",
    "2级标签": "2020年"
  }
}
```

### 修改后：
```json
{
  "文件名": "示例文件.pdf",
  "最终目标路径": "E:\\资料整理\\【02】宏观经济研究\\2020年\\示例文件.pdf",
  "标签": {
    "链式标签": "【02】宏观经济研究/2020年",
    "1级标签": "【02】宏观经济研究",
    "2级标签": "2020年"
  }
}
```

## 安全特性

1. **自动备份**：执行前自动创建带时间戳的备份文件
2. **试运行模式**：可以先试运行查看效果，不修改原文件
3. **错误处理**：详细的错误信息和处理统计
4. **进度显示**：实时显示处理进度

## 处理统计

工具会显示详细的处理统计信息：

- **总记录数**：JSON文件中的总记录数
- **已处理**：成功处理的记录数
- **新增链式标签**：新增了链式标签的记录数
- **已有链式标签**：已经存在链式标签的记录数
- **无级标签**：无法提取级标签的记录数
- **处理错误**：处理过程中出现错误的记录数

## 注意事项

1. **备份文件**：工具会自动创建备份，备份文件名格式为 `原文件名.backup_时间戳`
2. **文件格式**：确保JSON文件是数组格式，每个元素是一个对象
3. **编码格式**：文件使用UTF-8编码
4. **权限要求**：确保有读写文件的权限

## 错误处理

如果遇到错误，工具会：

1. 显示具体的错误信息
2. 继续处理其他记录
3. 在统计中显示错误数量
4. 不会因为个别记录的错误而中断整个处理过程

## 示例输出

```
============================================================
批量添加链式标签工具
============================================================
✓ 已备份原文件到: ai_organize_result.json.backup_20250115_143025
✓ 成功加载 6512 条记录

开始处理 6512 条记录...
  已处理 100/6512 条记录...
  已处理 200/6512 条记录...
  ...

============================================================
处理统计:
  总记录数: 6512
  已处理: 6422
  新增链式标签: 6422
  已有链式标签: 0
  无级标签: 90
  处理错误: 0
============================================================
✓ 数据已保存到: ai_organize_result.json

✓ 处理完成！
```

## 相关文件

- `batch_add_chain_tags.py`：批量添加链式标签工具
- `ai_organize_result.json`：处理结果文件
- `ai_organize_result.json.backup_*`：自动备份文件

## 技术支持

如果遇到问题，请检查：

1. Python环境是否正确
2. 文件路径是否正确
3. 文件格式是否符合要求
4. 是否有足够的磁盘空间（用于备份）
5. 是否有文件读写权限 