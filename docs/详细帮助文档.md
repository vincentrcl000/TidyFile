# TidyFile 详细帮助文档

## 📋 技术栈

- **后端**：Python 3.8+
- **前端**：HTML5 + CSS3 + JavaScript
- **AI模型**：Ollama (qwen3:4b)
- **GUI框架**：tkinter
- **文件处理**：PyPDF2, python-docx, Pillow
- **网络服务**：Flask

## 🛠️ 开发环境搭建

### 1. 环境准备

```bash
# 克隆项目
git clone <repository-url>
cd TidyFile

# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
.venv\Scripts\activate  # Windows
source .venv/bin/activate  # Linux/Mac

# 安装依赖
pip install -r requirements.txt
```

### 2. 运行应用

```bash
# 开发模式运行
python main.py

# 或者安装后运行
pip install -e .
tidyfile
```

### 3. AI模型配置

```bash
# 安装Ollama
# 下载地址: https://ollama.ai/

# 下载模型
ollama pull qwen3:4b

# 启动Ollama服务
ollama serve
```

### 4. 配置文件

配置文件现在自动存储在系统标准应用数据目录中：

**Windows**: `%APPDATA%/TidyFile/`
**macOS**: `~/Library/Application Support/TidyFile/`
**Linux**: `~/.config/TidyFile/`

**AI模型配置** (`config/ai_models_config.json`):
```json
{
  "models": [
    {
      "id": "ollama-local",
      "name": "本地Ollama模型",
      "base_url": "http://localhost:11434",
      "model_name": "qwen3:4b",
      "model_type": "ollama",
      "priority": 1,
      "enabled": true
    }
  ]
}
```

**分类规则配置** (`config/classification_rules.json`):
```json
{
  "工作文档": {
    "description": "工作相关的文档、报告、项目资料等",
    "keywords": ["工作", "项目", "报告", "会议", "计划"]
  }
}
```

**应用设置** (`config/app_settings.json`):
```json
{
  "app_info": {
    "version": "1.0.0",
    "last_updated": "2025-08-05T16:00:00Z"
  },
  "general": {
    "portable_mode": false,
    "language": "zh-CN",
    "theme": "default"
  }
}
```

### 5. 多语言支持

项目支持中文和英文界面切换：

**支持的语言**：
- 中文简体 (zh-CN)
- 英文 (en-US)

**语言设置方法**：
1. 启动应用程序
2. 点击"工具"页面
3. 点击"语言设置"按钮
4. 选择所需语言
5. 点击"应用"按钮
6. 重启应用程序使设置生效

**语言文件位置**：
- 中文：`user_data/locales/zh-CN.json`
- 英文：`user_data/locales/en-US.json`

**自动语言检测**：
- 首次运行时，程序会自动检测系统语言
- 如果检测到中文系统，自动使用中文界面
- 如果检测到英文系统，自动使用英文界面

## 🏗️ 项目架构

```
TidyFile/
├── src/tidyfile/                 # 主包
│   ├── core/                     # 核心功能模块
│   ├── gui/                      # GUI界面模块
│   ├── ai/                       # AI相关模块
│   ├── i18n/                     # 国际化模块
│   └── utils/                    # 工具模块
├── docs/                         # 文档目录
├── scripts/                      # 脚本目录
├── resources/                    # 资源文件目录
├── tests/                        # 测试目录
├── main.py                       # 主入口文件
└── setup.py                      # 安装脚本
```

### 应用数据目录结构

```
应用数据目录/
├── config/                    # 配置文件
│   ├── ai_models_config.json
│   ├── classification_rules.json
│   └── app_settings.json
├── data/                      # 数据文件
│   ├── cache/                 # 缓存文件
│   ├── logs/                  # 系统日志
│   ├── transfer_logs/         # 转移日志
│   └── results/               # 处理结果
├── temp/                      # 临时文件
└── user_data/                 # 用户自定义数据
    ├── templates/             # 自定义模板
    ├── custom_rules/          # 自定义规则
    └── locales/               # 多语言文件
        ├── zh-CN.json         # 中文简体
        └── en-US.json         # 英文
```

## 🔧 核心模块说明

### AI客户端管理 (`ai/client_manager.py`)

- 支持多种AI模型（Ollama、OpenAI等）
- 模型优先级管理
- 自动故障转移
- 请求重试机制

### 文件解读 (`core/file_reader.py`)

- 多格式文件支持（PDF、Word、TXT、图片等）
- 内容提取和预处理
- AI摘要生成
- 错误处理和重试

### 批量处理 (`core/multi_task_file_reader.py`)

- 多线程并发处理
- 进度监控和状态管理
- 结果聚合和去重
- 内存优化

### 智能分类 (`core/smart_classifier.py`)

- 基于AI的内容分析
- 自定义分类规则
- 目标路径匹配
- 文件移动和日志记录

## 🚀 启动方式

### 开发模式

```bash
# 激活虚拟环境
.venv\Scripts\activate

# 启动主程序
python main.py

# 启动文章阅读助手
python scripts/start_viewer_server.py
```

### 生产模式

```bash
# 使用启动脚本
scripts/启动文件整理器_新版本.bat
scripts/启动局域网服务器.bat
```

## 🔧 通用化改造使用说明

### 首次运行

首次运行时会自动执行配置迁移：
1. 检测旧配置文件位置
2. 迁移到系统标准应用数据目录
3. 清理个人数据（API密钥等）
4. 创建默认配置模板

### 便携模式

创建 `portable_mode.txt` 文件启用便携模式：
```bash
# 在项目根目录创建
echo "" > portable_mode.txt
```

便携模式下，所有数据存储在项目目录的 `app_data/` 文件夹中。

### 配置管理

配置文件位置：
- **安装模式**：系统标准应用数据目录
- **便携模式**：项目目录下的 `app_data/config/`

### 数据迁移

如需手动迁移配置：
```bash
python -c "from src.tidyfile.utils.config_migrator import ConfigMigrator; ConfigMigrator().migrate_all_configs()"
```

## 📊 数据格式

### 处理结果格式 (`ai_organize_result.json`)

```json
{
  "处理时间": "2025-08-05 16:30:00",
  "文件名": "example.pdf",
  "文章标题": "文档标题",
  "文章摘要": "文档摘要内容...",
  "源文件路径": "D:/原始文件/example.pdf",
  "最终目标路径": "D:/分类结果/工作文档/example.pdf",
  "处理状态": "分类成功",
  "处理耗时": 2.5,
  "文件元数据": {
    "file_size": 1024000,
    "modified_time": "2025-08-05 16:30:00",
    "file_type": "pdf"
  },
  "标签": {
    "链式标签": "工作文档/项目报告/2024年"
  }
}
```

### 日志格式

**系统日志** (`logs/`):
- 程序运行状态
- 错误信息记录
- 性能统计信息

**传输日志** (`transfer_logs/`):
- 文件移动记录
- 操作历史追踪
- 回滚操作支持

## 🔍 开发调试

### 诊断工具

```bash
# 检查Ollama服务
python -c "from src.tidyfile.ai.client_manager import get_ai_manager; print(get_ai_manager().test_all_connections())"

# 测试AI调用
python -c "from src.tidyfile.ai.client_manager import chat_with_ai; print(chat_with_ai([{'role': 'user', 'content': 'Hello'}]))"
```

### 日志查看

```bash
# 查看最新日志
tail -f logs/app.log

# 查看错误日志
grep "ERROR" logs/app.log
```

### 性能监控

- 内存使用监控
- 处理速度统计
- 并发性能测试
- 错误率统计

## 🧪 测试

### 单元测试

```bash
# 运行所有测试
python -m pytest tests/

# 运行特定模块测试
python -m pytest tests/test_file_reader.py
```

### 集成测试

```bash
# 测试完整流程
python tests/integration_test.py

# 测试AI模型连接
python tests/test_ai_models.py
```

## 🔧 配置优化

### 性能调优

```json
{
  "performance": {
    "max_workers": 4,
    "chunk_size": 1000,
    "timeout": 30,
    "retry_count": 3
  }
}
```

### 内存优化

- 分批处理大文件
- 及时释放内存
- 使用生成器处理大量数据
- 优化图片处理

## 🚀 部署

### 生产环境

1. **环境准备**：
   - Python 3.8+
   - 4GB+ 内存
   - 稳定的网络连接

2. **服务配置**：
   - 配置AI模型
   - 设置文件权限
   - 配置防火墙

3. **监控配置**：
   - 日志轮转
   - 性能监控
   - 错误告警

### Docker部署

```dockerfile
FROM python:3.8-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 5000

CMD ["python", "scripts/start_viewer_server.py"]
```

## 🤝 贡献指南

### 开发流程

1. Fork 项目
2. 创建功能分支
3. 提交代码
4. 创建 Pull Request

### 代码规范

- 遵循 PEP 8 规范
- 添加类型注解
- 编写文档字符串
- 添加单元测试

### 提交规范

```
feat: 添加新功能
fix: 修复bug
docs: 更新文档
style: 代码格式调整
refactor: 代码重构
test: 添加测试
chore: 构建过程或辅助工具的变动
```

## 📄 许可证

MIT License

## 📞 支持

- **文档**：查看 `docs/` 目录
- **Issues**：提交问题和建议
- **讨论**：参与项目讨论

---

**版本**：2.0.0  
**更新时间**：2025-08-05  
**维护者**：AI Assistant 